<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2.0 Mini App</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      background-color: #000;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    .rotating-border {
      border-radius: 50%;
      padding: 3px;
      background: linear-gradient(45deg, #f3ec78, #af4261);
      animation: rotate 3s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .cylindrical-button {
      border-radius: 20px;
      padding: 8px 16px;
      transition: all 0.3s ease;
    }
    
    .ziz-zizz-circle {
      background: linear-gradient(45deg, #f3ec78, #af4261);
      color: black;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="app"></div>

<script type="text/babel">
  const { useState, useEffect, Component } = React;

  // Utility functions
  const safeLocalStorage = {
    getItem: (key, defaultValue) => {
      try {
        const value = localStorage.getItem(key);
        return value ? JSON.parse(value) : defaultValue;
      } catch (e) {
        return defaultValue;
      }
    },
    setItem: (key, value) => {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error('LocalStorage error:', e);
      }
    }
  };

  const sanitizeInitData = (userData) => {
    return userData ? {
      id: userData.id,
      username: userData.username || 'Unknown',
      first_name: userData.first_name,
      last_name: userData.last_name
    } : null;
  };

  const showError = (message) => {
    if (window.Telegram?.WebApp?.showAlert) {
      window.Telegram.WebApp.showAlert(message);
    } else {
      alert(message);
    }
  };

  const isTelegramWebApp = () => {
    try {
      return window.Telegram && window.Telegram.WebApp;
    } catch (e) {
      return false;
    }
  };

  // Components
  class ErrorBoundary extends Component {
    state = { hasError: false };
    
    static getDerivedStateFromError() {
      return { hasError: true };
    }
    
    componentDidCatch(error, info) {
      console.error('ErrorBoundary caught:', error, info);
    }
    
    render() {
      if (this.state.hasError) {
        return (
          <div className="p-4 text-red-500">
            Something went wrong. Please refresh the app.
          </div>
        );
      }
      return this.props.children;
    }
  }

  function IntroScreen({ onComplete }) {
    return (
      <div className="fixed inset-0 bg-black flex items-center justify-center z-50">
        <div className="text-center p-6 max-w-md">
          <h1 className="text-3xl font-bold mb-4 text-white">Welcome to 2.0</h1>
          <p className="text-white mb-8">Complete tasks to earn $2.0 tokens</p>
          <button
            onClick={onComplete}
            className="bg-white text-black px-6 py-3 rounded-full font-bold"
          >
            Get Started
          </button>
        </div>
      </div>
    );
  }

  function AirdropCriteriaModal({ isOpen, onClose, onConnectWallet, onJoinChannel, onInviteFriend, walletConnected, joinChannelCompleted, inviteFriendCompleted }) {
    if (!isOpen) return null;

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-[#181818] rounded-lg p-6 w-full max-w-md">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-white">Airdrop Criteria</h2>
            <button
              onClick={onClose}
              className="text-white"
              aria-label="Close airdrop criteria modal"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div className="space-y-4">
            <div className="flex justify-between items-center p-2 bg-[#282828] rounded">
              <span className="text-white">Connect Wallet</span>
              <button
                onClick={onConnectWallet}
                disabled={walletConnected}
                className={`cylindrical-button ziz-zizz-circle p-2 ${walletConnected ? 'bg-[#181818]' : 'bg-white text-black'}`}
              >
                {walletConnected ? '✓' : 'Go'}
              </button>
            </div>
            <div className="flex justify-between items-center p-2 bg-[#282828] rounded">
              <span className="text-white">Join @Twopoint0_bot</span>
              <button
                onClick={onJoinChannel}
                disabled={joinChannelCompleted}
                className={`cylindrical-button ziz-zizz-circle p-2 ${joinChannelCompleted ? 'bg-[#181818]' : 'bg-white text-black'}`}
              >
                {joinChannelCompleted ? '✓' : 'Go'}
              </button>
            </div>
            <div className="flex justify-between items-center p-2 bg-[#282828] rounded">
              <span className="text-white">Invite 1 Friend</span>
              <button
                onClick={onInviteFriend}
                disabled={inviteFriendCompleted}
                className={`cylindrical-button ziz-zizz-circle p-2 ${inviteFriendCompleted ? 'bg-[#181818]' : 'bg-white text-black'}`}
              >
                {inviteFriendCompleted ? '✓' : 'Go'}
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  function TwoPointZeroApp() {
    const defaultTasks = [
      { id: 1, name: "Join @Twopoint0_bot", reward: 1000, completed: false },
      { id: 2, name: "Follow on X", reward: 500, completed: false },
      { id: 3, name: "Daily Check-In", reward: 200, completed: false },
    ];

    const [user, setUser] = useState(() => sanitizeInitData(null));
    const [tokens, setTokens] = useState(() => safeLocalStorage.getItem('tokens', 0));
    const [chatCount, setChatCount] = useState(() => safeLocalStorage.getItem('chatCount', 0));
    const [tasks, setTasks] = useState(() => {
      const savedTasks = safeLocalStorage.getItem('tasks', []);
      return Array.isArray(savedTasks) && savedTasks.length > 0 ? savedTasks : defaultTasks;
    });
    const [referralCount, setReferralCount] = useState(() => safeLocalStorage.getItem('referralCount', 0));
    const [referredUsers, setReferredUsers] = useState(() => safeLocalStorage.getItem('referredUsers', []));
    const [referralCommissions, setReferralCommissions] = useState(() => safeLocalStorage.getItem('referralCommissions', 0));
    const [walletConnected, setWalletConnected] = useState(() => safeLocalStorage.getItem('walletConnected', false));
    const [airdropClaimed, setAirdropClaimed] = useState(() => safeLocalStorage.getItem('airdropClaimed', false));
    const [activeTab, setActiveTab] = useState('home');
    const [showIntro, setShowIntro] = useState(() => !safeLocalStorage.getItem('introShown', false));
    const [showModal, setShowModal] = useState(false);
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
      const timeout = setTimeout(() => {
        safeLocalStorage.setItem('tokens', tokens);
        safeLocalStorage.setItem('tasks', tasks);
        safeLocalStorage.setItem('referralCount', referralCount);
        safeLocalStorage.setItem('referredUsers', referredUsers);
        safeLocalStorage.setItem('referralCommissions', referralCommissions);
        safeLocalStorage.setItem('walletConnected', walletConnected);
        safeLocalStorage.setItem('airdropClaimed', airdropClaimed);
        safeLocalStorage.setItem('chatCount', chatCount);
      }, 500);
      return () => clearTimeout(timeout);
    }, [tokens, tasks, referralCount, referredUsers, referralCommissions, walletConnected, airdropClaimed, chatCount]);

    useEffect(() => {
      const initApp = async () => {
        try {
          if (isTelegramWebApp()) {
            window.Telegram.WebApp.ready();
            const initData = window.Telegram.WebApp.initDataUnsafe || {};
            setUser(sanitizeInitData(initData.user));
            window.Telegram.WebApp.expand();
          } else {
            setUser({ username: 'Guest', id: 'unknown' });
            showError('Running in Guest mode. For full features, open in Telegram.');
          }

          if (!chatCount) {
            const randomChats = Math.floor(Math.random() * 50) + 1;
            setChatCount(randomChats);
            const baseTokens = randomChats * 100;
            setTokens(prev => prev + baseTokens);
          }
        } catch (e) {
          console.error('Initialization error:', e);
          showError('Failed to initialize app. Please refresh.');
        }
      };

      initApp();
    }, []);

    const completeTask = (taskId) => {
      setTasks(prevTasks => {
        const updatedTasks = prevTasks.map(task =>
          task.id === taskId ? { ...task, completed: true } : task
        );
        return updatedTasks;
      });
      
      const task = tasks.find(t => t.id === taskId);
      if (task && !task.completed) {
        setTokens(prev => prev + task.reward);
      }
    };

    const handleJoinChannel = async () => {
      try {
        const channelLink = 'https://t.me/Twopoint0_bot';
        if (isTelegramWebApp()) {
          await window.Telegram.WebApp.openTelegramLink(channelLink);
        } else {
          window.open(channelLink, '_blank');
        }
        completeTask(1);
      } catch (e) {
        showError('Failed to open channel: ' + e.message);
      }
    };

    const addReferral = () => {
      const newReferralId = `ref_${referralCount + 1}_${Date.now()}`;
      const referralTokens = Math.floor(Math.random() * 5000) + 1000;
      const commission = Math.floor(referralTokens * 0.1);
      
      setReferralCount(prev => prev + 1);
      setReferredUsers(prev => prev.concat({ id: newReferralId, tokens: referralTokens }));
      setReferralCommissions(prev => prev + commission);
      setTokens(prev => prev + commission);
    };

    const updateReferralTokens = (referralId) => {
      setReferredUsers(prev => {
        return prev.map(user => {
          if (user.id === referralId) {
            const newTokens = Math.floor(Math.random() * 5000) + 1000;
            const oldCommission = Math.floor(user.tokens * 0.1);
            const newCommission = Math.floor(newTokens * 0.1);
            const commissionDiff = newCommission - oldCommission;
            
            setReferralCommissions(prevComm => prevComm + commissionDiff);
            setTokens(prevTokens => prevTokens + commissionDiff);
            
            return { ...user, tokens: newTokens };
          }
          return user;
        });
      });
    };

    const connectWallet = () => {
      setWalletConnected(true);
      setTokens(prev => prev + 1000);
      showError('Simulated TON wallet connected! +1000 $2.0');
    };

    const handleAirdrop = () => {
      if (airdropClaimed) {
        showError('Airdrop already claimed.');
        return;
      }

      const joinChannelTask = tasks.find(task => task.id === 1);
      const joinChannelCompleted = joinChannelTask ? joinChannelTask.completed : false;
      const inviteFriendCompleted = referralCount > 0;
      const criteriaMet = walletConnected && joinChannelCompleted && inviteFriendCompleted;

      if (criteriaMet) {
        setTokens(prev => prev + 5000);
        setAirdropClaimed(true);
        showError('Airdrop claimed! +5000 $2.0');
      } else {
        const unmetCriteria = [];
        if (!walletConnected) unmetCriteria.push('Connect Wallet');
        if (!joinChannelCompleted) unmetCriteria.push('Join @Twopoint0_bot');
        if (!inviteFriendCompleted) unmetCriteria.push('Invite 1 Friend');
        showError(`Please complete: ${unmetCriteria.join(', ')}.`);
      }
    };

    const shareScore = () => {
      const referralLink = user ? `t.me/Twopoint0_bot?start=ref_${user.id || 'unknown'}` : 't.me/Twopoint0_bot';
      const shareText = `I have ${Math.floor(tokens)} $2.0 in the 2.0 Mini App! Join me: ${referralLink}`;
      
      if (isTelegramWebApp()) {
        window.Telegram.WebApp.openTelegramLink(
          `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(shareText)}`
        );
      } else {
        alert('Sharing is only available in Telegram. Here\'s your link:\n' + referralLink);
      }
    };

    const toggleModal = () => {
      setShowModal(prev => !prev);
    };

    const joinChannelCompleted = tasks.find(task => task.id === 1)?.completed || false;
    const inviteFriendCompleted = referralCount > 0;

    if (showIntro) {
      return <IntroScreen onComplete={() => {
        safeLocalStorage.setItem('introShown', true);
        setShowIntro(false);
      }} />;
    }

    return (
      <div className="min-h-screen text-white flex flex-col items-center p-4 pb-16">
        {/* Balance Circle */}
        <div className="flex justify-center mb-4">
          <div className="rotating-border">
            <div className="bg-black rounded-full w-28 h-28 flex items-center justify-center text-center shadow-lg">
              <div>
                <p className="text-lg font-bold text-white">{Math.floor(tokens)}</p>
                <p className="text-sm text-white">$2.0</p>
              </div>
            </div>
          </div>
        </div>

        {/* Header */}
        <div className="w-full max-w-md flex justify-between items-center mt-4 mb-4">
          <div className="flex items-center">
            <h1 className="text-xl font-bold">2.0 App</h1>
          </div>
          <div className="flex space-x-3">
            <button
              onClick={shareScore}
              className="text-white"
              title="Share Score"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C9.484 12.542 10.8 12.542 11.6 13.342L15.658 17.4C16.458 18.2 16.458 19.516 15.658 20.316C14.858 21.116 13.542 21.116 12.742 20.316L12 19.574L11.258 20.316C10.458 21.116 9.142 21.116 8.342 20.316C7.542 19.516 7.542 18.2 8.342 17.4L12.4 13.342C13.2 12.542 14.516 12.542 15.316 13.342M12 4V16" />
              </svg>
            </button>
            <button
              onClick={toggleModal}
              className="bg-gray-300 text-black px-3 py-1 rounded text-sm font-medium"
              title="Airdrop Criteria"
            >
              Airdrop
            </button>
          </div>
        </div>

        {/* Airdrop Criteria Modal */}
        <AirdropCriteriaModal
          isOpen={showModal}
          onClose={toggleModal}
          onConnectWallet={connectWallet}
          onJoinChannel={handleJoinChannel}
          onInviteFriend={addReferral}
          walletConnected={walletConnected}
          joinChannelCompleted={joinChannelCompleted}
          inviteFriendCompleted={inviteFriendCompleted}
        />

        {/* User Info */}
        <div className="w-full max-w-md bg-[#181818] rounded-lg p-4 mb-4">
          <p>Chats: {chatCount} | Referrals: {referralCount} | Commissions: {referralCommissions} $2.0</p>
        </div>

        {/* Tab Content */}
        <div className="w-full max-w-md">
          {activeTab === 'home' && (
            <div className="bg-black rounded-lg p-4">
              <div className="mt-4">
                <h4 className="text-lg font-bold mb-2">Tasks</h4>
                {tasks.map(task => (
                  <div
                    key={task.id}
                    className="flex justify-between items-center p-2 bg-[#181818] rounded mb-2"
                  >
                    <span>{task.name} (+{task.reward} $2.0)</span>
                    {task.id === 1 ? (
                      <button
                        onClick={handleJoinChannel}
                        disabled={task.completed}
                        className={`px-4 py-1 rounded ${task.completed ? 'bg-[#181818]' : 'bg-white text-black'}`}
                      >
                        {task.completed ? '✓' : 'Go'}
                      </button>
                    ) : (
                      <button
                        onClick={() => completeTask(task.id)}
                        disabled={task.completed}
                        className={`px-4 py-1 rounded ${task.completed ? 'bg-[#181818]' : 'bg-white text-black'}`}
                      >
                        {task.completed ? '✓' : 'Go'}
                      </button>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}
          {activeTab === 'referrals' && (
            <div className="bg-[#181818] rounded-lg p-4">
              <h3 className="text-lg font-bold mb-2">Referrals</h3>
              <p>Invite friends to earn 10% of their $2.0 tokens!</p>
              <p>Referral Count: {referralCount}</p>
              <p>Total Commissions: {referralCommissions} $2.0</p>
              {referredUsers.length > 0 && (
                <div className="mt-4">
                  <h4 className="text-md font-bold mb-2">Referred Users</h4>
                  {referredUsers.map(user => (
                    <div key={user.id} className="flex justify-between items-center p-2 bg-[#282828] rounded mb-2">
                      <span>User {user.id}: {user.tokens} $2.0</span>
                      <button
                        onClick={() => updateReferralTokens(user.id)}
                        className="px-4 py-1 bg-gray-300 text-black rounded"
                      >
                        Update
                      </button>
                    </div>
                  ))}
                </div>
              )}
              <button
                onClick={addReferral}
                className="mt-4 bg-gray-300 text-black px-4 py-2 rounded w-full"
              >
                Invite Friends
              </button>
              <button
                onClick={shareScore}
                className="mt-2 bg-gray-300 text-black px-4 py-2 rounded w-full"
              >
                Share Referral Link
              </button>
            </div>
          )}
          {activeTab === 'wallet' && (
            <div className="bg-[#181818] rounded-lg p-4">
              <h3 className="text-lg font-bold mb-2">Wallet</h3>
              {walletConnected ? (
                <p>TON Wallet Connected!</p>
              ) : (
                <button
                  onClick={connectWallet}
                  className="bg-gray-300 text-black px-4 py-2 rounded w-full"
                >
                  Connect TON Wallet
                </button>
              )}
              <button
                onClick={handleAirdrop}
                disabled={airdropClaimed}
                className={`mt-4 px-4 py-2 rounded w-full ${airdropClaimed ? 'bg-[#181818]' : 'bg-white text-black'}`}
              >
                {airdropClaimed ? 'Airdrop Claimed' : 'Claim Airdrop'}
              </button>
            </div>
          )}
        </div>

        {/* Bottom Navigation */}
        <div className="fixed bottom-0 left-0 right-0 bg-[#181818] p-2 flex justify-around w-full max-w-md mx-auto">
          <button
            className={`p-2 rounded ${activeTab === 'referrals' ? 'bg-blac
